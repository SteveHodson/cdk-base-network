
# Generic VPC solution generated by CDK

This project sets out to achieve what I have created before, namely a standard VPC template similar to the [standard VPC template issued by AWS](https://aws.amazon.com/quickstart/architecture/vpc/).
The AWS published version was huge and did require some manual input before it could be applied.  So I set about creating a version that was more tidy in presentation and used a Lambda function to calculate the subnet cidr ranges.

With the advent of AWS CDK I thought it would be good to revisit this project and see if I cannot make the solution even simpler to use without skipping on the final result.  This project is a first attempt.

## How To
This project relies on a version 1.55 of the CDK, although it should be backwards compatible down to v1.0.

After fetch this repo to convenient place in your development environment, create the virtual environment, if you have not got the module installed.
```
$ python3 -m venv .env
```
Next activate the virtual environment
```
$ source .env/bin/activate
```
Now the virtual environment is setup pull in all the dependencies
```
$ pip install -r requirements.txt
```
If this is the first time of using CDK...
```
$ cdk bootstrap
```

Look in the `./cdk.json` file and you will see some configuration for you to complete.  Do this now.
```
"envs": {
  "prod": {                  <--- Name of your environment
    "account": "YOUR AWS ACCOUNT NUMBER",
    "region": "eu-west-1",   <--- Region you wish to work in
    "vpc_config": {
      "cidr": "10.0.0.0/16"  <--- cidr block for VPC
      "zones": "3",          <--- AZ required and will determine # of NATs
      "layers": "3"          <--- Number of network layers minumum of 2
    }
  }
}

```
Next synthesize the template using
```
$ cdk synth [env=prod]
```
The optional element depends on what you have called your environment in `cdk.json`.

To deploy use
```
$ cdk deploy [env=prod]
```

To remove the network
```
$ cdk destroy
```

## Note on IP allocation
Many VPC solutions I have seen allocate IP addresses using the standard `/24`.  While this does get you going I have seen networks run out of space and so the solution here is to tear down the network and start again or add new subnets which created further headaches with regards to firewalls and routing.  To help out AWS introduced the concept of extending a subnet at some later date which then lead to allocation spaces looking more like an un-defragged disk!
A better solution involves taking the whole IP allocation (VPC Cidr block) and halving it once.  This will be your most populous layer and in my experience this has been the Private layer.  With what is left half again and this can be your public subnets, halve again and repeat for as many layers as you want.

This is the thought behind the IP allocation shown in the AWS VPC template and something I have replicated here in this project.

The net effect of this is to give appropriate sizes to subnets right from the start minimizing the necessity of resizing or worse tearing down.

## Future
I think this could well be suitable as a high level contruct so that it is stored away in something repo (eg Code Artifact) and just an `app.py` and `cdk.json` would be needed for any networking requirements.  Sometimes there are requirements that this project will not cater for... the CDK will allow you to build a specialised network very quickly.
   
